#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>

#define NORD 17
#define SUD 18
#define EST 39
#define OUEST 40

BLEServer *pServer = nullptr;
BLECharacteristic *pCharacteristic = nullptr;
bool deviceConnected = false;

void setup() {
    Serial.begin(115200);
    BLEDevice::init("ESP32-S3-BLE");

    pServer = BLEDevice::createServer();
    pServer->setCallbacks(new class : public BLEServerCallbacks {
        void onConnect(BLEServer* pServer) override { deviceConnected = true; }
        void onDisconnect(BLEServer* pServer) override { deviceConnected = false; }
    });

    BLEService *pService = pServer->createService(BLEUUID((uint16_t)0x180C));
    pCharacteristic = pService->createCharacteristic(
        BLEUUID((uint16_t)0x2A56),
        BLECharacteristic::PROPERTY_READ | BLECharacteristic::PROPERTY_NOTIFY
    );

    pCharacteristic->addDescriptor(new BLE2902());
    pService->start();
    pServer->getAdvertising()->start();

    pinMode(NORD, INPUT);
    pinMode(SUD, INPUT);
    pinMode(EST, INPUT);
    pinMode(OUEST, INPUT);
}

void loop() {
    if (deviceConnected) {
        int nordVal = analogRead(NORD);
        int sudVal = analogRead(SUD);
        int estVal = analogRead(EST);
        int ouestVal = analogRead(OUEST);

        String data = "Nord: " + String(nordVal) + ", Sud: " + String(sudVal) +
                      ", Est: " + String(estVal) + ", Ouest: " + String(ouestVal);

        Serial.println(data);
        pCharacteristic->setValue(data.c_str());
        pCharacteristic->notify();
    }
    delay(1000);
}

